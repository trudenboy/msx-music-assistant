<!DOCTYPE html>
<html>
<head>
    <title>MSX Kiosk Player</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fff;
        }

        /* Sync indicator */
        .sync-indicator {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
            background: rgba(255, 152, 0, 0.9);
            z-index: 1000;
        }
        .sync-indicator.synced { background: rgba(76, 175, 80, 0.9); }
        .sync-indicator.syncing { background: rgba(255, 152, 0, 0.9); animation: pulse 1.5s infinite; }
        .sync-indicator.error { background: rgba(244, 67, 54, 0.9); }
        .sync-indicator.hidden { display: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Main container */
        .kiosk-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
        }

        /* Album art */
        .album-art {
            width: 45vmin;
            height: 45vmin;
            max-width: 400px;
            max-height: 400px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            margin-bottom: 28px;
        }

        .album-art-placeholder {
            width: 45vmin;
            height: 45vmin;
            max-width: 400px;
            max-height: 400px;
            border-radius: 8px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 28px;
            font-size: 80px;
            color: #333;
        }

        /* Track info */
        .track-title {
            font-size: 1.6rem;
            font-weight: 600;
            text-align: center;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            font-size: 1rem;
            color: rgba(255,255,255,0.6);
            text-align: center;
            margin-top: 8px;
        }

        /* Progress bar */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 28px;
            width: min(50vw, 400px);
        }

        .time {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            font-variant-numeric: tabular-nums;
            min-width: 40px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            transition: width 0.3s linear;
        }

        /* Controls */
        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 24px;
        }

        .controls.hidden {
            display: none;
        }

        .ctrl-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: background 0.15s, color 0.15s;
        }

        .ctrl-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .ctrl-btn:focus {
            outline: 2px solid rgba(255,255,255,0.5);
            outline-offset: 2px;
        }

        .ctrl-btn.primary {
            width: 64px;
            height: 64px;
            background: #fff;
            color: #000;
            font-size: 32px;
        }

        .ctrl-btn.primary:hover {
            background: #e0e0e0;
        }

        /* Waiting state */
        .waiting-message {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.4);
            text-align: center;
            margin-top: 20px;
        }
    </style>
    <script type="text/javascript" src="//msx.benzac.de/js/tvx-plugin.min.js"></script>
</head>
<body>
<div id="sync-indicator" class="sync-indicator">CONNECTING...</div>

<div class="kiosk-container">
    <img id="album-art" class="album-art" src="" alt="" style="display: none;">
    <div id="album-art-placeholder" class="album-art-placeholder">♫</div>

    <div id="track-title" class="track-title">Waiting for playback...</div>
    <div id="track-artist" class="track-artist"></div>

    <div class="progress-container">
        <span id="time-current" class="time">0:00</span>
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        <span id="time-total" class="time">0:00</span>
    </div>

    <div id="controls" class="controls">
        <button id="btn-prev" class="ctrl-btn" title="Previous">⏮</button>
        <button id="btn-play" class="ctrl-btn primary" title="Play/Pause">▶</button>
        <button id="btn-next" class="ctrl-btn" title="Next">⏭</button>
    </div>
</div>

<script type="text/javascript">
(function() {
    "use strict";

    // Configuration (injected by server)
    var KIOSK_MODE = "standard"; // "standard" or "sendspin"
    var SHOW_CONTROLS = true;
    var SENDSPIN_SERVER = "";
    var BRIDGE_URL = "";

    // State
    var isPlaying = false;
    var position = 0;
    var duration = 0;
    var currentTrack = null;
    var ws = null;
    var wsRetry = 1000;
    var deviceId = "";
    var logger = null;

    // Sendspin state
    var sendspinPlayer = null;
    var sendspinReady = false;
    var SendspinPlayerClass = null;

    // DOM elements
    var syncIndicator = null;
    var albumArt = null;
    var albumArtPlaceholder = null;
    var trackTitle = null;
    var trackArtist = null;
    var timeCurrent = null;
    var timeTotal = null;
    var progressFill = null;
    var controls = null;
    var btnPlay = null;
    var btnPrev = null;
    var btnNext = null;

    function generateDeviceId() {
        var chars = "abcdefghijklmnopqrstuvwxyz0123456789";
        var id = "msx_kiosk_";
        for (var i = 0; i < 8; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return id;
    }

    function fmtDur(sec) {
        if (!sec || !isFinite(sec) || sec < 0) return "0:00";
        var m = Math.floor(sec / 60);
        var s = Math.floor(sec % 60);
        return m + ":" + (s < 10 ? "0" : "") + s;
    }

    function updateSyncIndicator(status, text) {
        if (!syncIndicator) return;
        syncIndicator.className = "sync-indicator";
        if (status === "synced") {
            syncIndicator.classList.add("synced");
            syncIndicator.textContent = text || "SYNC";
        } else if (status === "syncing") {
            syncIndicator.classList.add("syncing");
            syncIndicator.textContent = text || "SYNCING...";
        } else if (status === "error") {
            syncIndicator.classList.add("error");
            syncIndicator.textContent = text || "ERROR";
        } else if (status === "hidden") {
            syncIndicator.classList.add("hidden");
        } else {
            syncIndicator.textContent = text || "CONNECTING...";
        }
    }

    function updateUI() {
        // Update play button
        if (btnPlay) {
            btnPlay.textContent = isPlaying ? "⏸" : "▶";
            btnPlay.title = isPlaying ? "Pause" : "Play";
        }

        // Update progress
        if (timeCurrent) timeCurrent.textContent = fmtDur(position);
        if (timeTotal) timeTotal.textContent = fmtDur(duration);
        if (progressFill && duration > 0) {
            progressFill.style.width = ((position / duration) * 100) + "%";
        }
    }

    function updateTrackInfo(track) {
        currentTrack = track;

        if (trackTitle) trackTitle.textContent = track.title || "No track playing";
        if (trackArtist) trackArtist.textContent = track.artist || "";

        if (albumArt && albumArtPlaceholder) {
            if (track.image) {
                albumArt.src = track.image;
                albumArt.style.display = "";
                albumArtPlaceholder.style.display = "none";
            } else {
                albumArt.style.display = "none";
                albumArtPlaceholder.style.display = "";
            }
        }

        duration = track.duration || 0;
        updateUI();
    }

    // --- Sendspin Mode ---
    function loadSendspinSDK(callback) {
        if (SendspinPlayerClass) {
            callback(SendspinPlayerClass, null);
            return;
        }

        var supportsModules = false;
        try {
            new Function("import('')");
            supportsModules = true;
        } catch (e) {
            supportsModules = false;
        }

        if (!supportsModules) {
            callback(null, "ES modules not supported");
            return;
        }

        var script = document.createElement("script");
        script.type = "module";
        script.textContent = [
            "import { SendspinPlayer } from 'https://unpkg.com/@music-assistant/sendspin-js@latest/dist/index.js';",
            "window.__SendspinPlayerClass = SendspinPlayer;",
            "window.dispatchEvent(new CustomEvent('sendspin-sdk-loaded'));"
        ].join("\n");

        var loadTimeout = setTimeout(function() {
            callback(null, "SDK load timeout");
        }, 10000);

        window.addEventListener("sendspin-sdk-loaded", function onLoaded() {
            window.removeEventListener("sendspin-sdk-loaded", onLoaded);
            clearTimeout(loadTimeout);
            if (window.__SendspinPlayerClass) {
                SendspinPlayerClass = window.__SendspinPlayerClass;
                callback(SendspinPlayerClass, null);
            } else {
                callback(null, "SDK class not found");
            }
        });

        script.onerror = function() {
            clearTimeout(loadTimeout);
            callback(null, "Failed to load SDK");
        };

        document.head.appendChild(script);
    }

    function initSendspin() {
        updateSyncIndicator("syncing", "LOADING SDK...");

        loadSendspinSDK(function(PlayerClass, error) {
            if (error || !PlayerClass) {
                logger.error("Sendspin SDK load failed: " + (error || "unknown"));
                updateSyncIndicator("error", "SDK ERROR");
                return;
            }

            logger.debug("Sendspin SDK loaded, connecting to:", SENDSPIN_SERVER);
            updateSyncIndicator("syncing", "CONNECTING...");

            try {
                sendspinPlayer = new PlayerClass({
                    playerId: deviceId,
                    baseUrl: SENDSPIN_SERVER,
                    clientName: "MSX Kiosk Player",
                    correctionMode: "sync",
                    onStateChange: onSendspinStateChange
                });

                sendspinPlayer.connect()
                    .then(function() {
                        logger.debug("Sendspin connected");
                        sendspinReady = true;
                        updateSyncIndicator("synced", "SYNC");
                    })
                    .catch(function(err) {
                        logger.error("Sendspin connection failed: " + err.message);
                        updateSyncIndicator("error", "CONNECT FAILED");
                    });
            } catch (e) {
                logger.error("Sendspin init error: " + e.message);
                updateSyncIndicator("error", "INIT ERROR");
            }
        });
    }

    function onSendspinStateChange(state) {
        logger.debug("Sendspin state changed");

        // Update playing state
        isPlaying = sendspinPlayer ? sendspinPlayer.isPlaying : false;

        // Update metadata
        if (state.serverState && state.serverState.metadata) {
            var meta = state.serverState.metadata;
            updateTrackInfo({
                title: meta.title || "",
                artist: meta.artist || "",
                image: meta.artwork_url || "",
                duration: meta.track_duration ? meta.track_duration / 1000 : 0
            });
        }

        // Update position
        if (sendspinPlayer && sendspinPlayer.trackProgress) {
            var progress = sendspinPlayer.trackProgress;
            position = progress.positionMs / 1000;
            duration = progress.durationMs / 1000;
        }

        // Update sync status
        if (sendspinPlayer && sendspinPlayer.isClockSynced) {
            updateSyncIndicator("synced", "SYNC");
        } else if (sendspinReady) {
            updateSyncIndicator("syncing", "SYNCING...");
        }

        updateUI();
    }

    // --- Standard Mode (WebSocket) ---
    function connectWS() {
        if (KIOSK_MODE !== "standard") return;

        var wsUrl = (location.protocol === "https:" ? "wss:" : "ws:") +
                    "//" + location.host + "/ws" +
                    "?device_id=" + encodeURIComponent(deviceId) + "&source=msx_kiosk";

        ws = new WebSocket(wsUrl);
        var thisWs = ws;

        ws.onopen = function() {
            logger.debug("WebSocket connected");
            wsRetry = 1000;
            updateSyncIndicator("hidden");
        };

        ws.onmessage = function(ev) {
            try {
                handleWSMessage(JSON.parse(ev.data));
            } catch (e) {
                logger.warn("WS message error: " + e.message);
            }
        };

        ws.onclose = function(ev) {
            if (ws !== thisWs) return;
            ws = null;
            if (ev.code !== 1000 && ev.code !== 1001) {
                updateSyncIndicator("syncing", "RECONNECTING...");
                var jitter = Math.random() * 1000;
                setTimeout(connectWS, wsRetry + jitter);
                wsRetry = Math.min(wsRetry * 2, 10000);
            }
        };

        ws.onerror = function() {
            updateSyncIndicator("error", "CONNECTION ERROR");
        };
    }

    function handleWSMessage(msg) {
        switch (msg.type) {
            case "play":
                isPlaying = true;
                updateTrackInfo({
                    title: msg.title || "",
                    artist: msg.artist || "",
                    image: msg.image_url || "",
                    duration: msg.duration || 0
                });
                break;
            case "stop":
                isPlaying = false;
                position = 0;
                updateTrackInfo({ title: "Waiting for playback...", artist: "", image: "", duration: 0 });
                break;
            case "pause":
                isPlaying = false;
                break;
            case "resume":
                isPlaying = true;
                break;
            case "position":
                position = msg.position || 0;
                break;
            case "metadata":
                updateTrackInfo({
                    title: msg.title || currentTrack.title,
                    artist: msg.artist || currentTrack.artist,
                    image: msg.image_url || currentTrack.image,
                    duration: msg.duration || currentTrack.duration
                });
                break;
        }
        updateUI();
    }

    function sendWSCommand(type, data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            var msg = Object.assign({ type: type }, data || {});
            ws.send(JSON.stringify(msg));
        }
    }

    // --- Controls ---
    function togglePlay() {
        if (KIOSK_MODE === "sendspin" && sendspinPlayer && sendspinReady) {
            if (sendspinPlayer.isPlaying) {
                sendspinPlayer.sendCommand("pause");
            } else {
                sendspinPlayer.sendCommand("play");
            }
        } else if (KIOSK_MODE === "standard") {
            sendWSCommand(isPlaying ? "pause" : "resume");
        }
    }

    function prevTrack() {
        if (KIOSK_MODE === "sendspin" && sendspinPlayer && sendspinReady) {
            sendspinPlayer.sendCommand("previous");
        } else if (KIOSK_MODE === "standard") {
            sendWSCommand("previous");
        }
    }

    function nextTrack() {
        if (KIOSK_MODE === "sendspin" && sendspinPlayer && sendspinReady) {
            sendspinPlayer.sendCommand("next");
        } else if (KIOSK_MODE === "standard") {
            sendWSCommand("next");
        }
    }

    // --- MSX Plugin Interface ---
    function KioskPlugin() {
        this.init = function() {
            logger = new TVXLogger();

            // Get DOM elements
            syncIndicator = document.getElementById("sync-indicator");
            albumArt = document.getElementById("album-art");
            albumArtPlaceholder = document.getElementById("album-art-placeholder");
            trackTitle = document.getElementById("track-title");
            trackArtist = document.getElementById("track-artist");
            timeCurrent = document.getElementById("time-current");
            timeTotal = document.getElementById("time-total");
            progressFill = document.getElementById("progress-fill");
            controls = document.getElementById("controls");
            btnPlay = document.getElementById("btn-play");
            btnPrev = document.getElementById("btn-prev");
            btnNext = document.getElementById("btn-next");

            // Parse configuration from URL params
            KIOSK_MODE = TVXServices.urlParams.get("mode", "standard");
            SHOW_CONTROLS = TVXServices.urlParams.get("controls", "true") === "true";
            SENDSPIN_SERVER = TVXServices.urlParams.get("sendspin_server", "");
            BRIDGE_URL = TVXServices.urlParams.get("bridge", location.origin);

            // Generate device ID
            deviceId = TVXServices.urlParams.get("device_id", "") || generateDeviceId();

            logger.debug("Kiosk init: mode=" + KIOSK_MODE + ", controls=" + SHOW_CONTROLS);

            // Show/hide controls
            if (controls && !SHOW_CONTROLS) {
                controls.classList.add("hidden");
            }

            // Setup control buttons
            if (btnPlay) btnPlay.addEventListener("click", togglePlay);
            if (btnPrev) btnPrev.addEventListener("click", prevTrack);
            if (btnNext) btnNext.addEventListener("click", nextTrack);
        };

        this.ready = function() {
            logger.debug("Kiosk ready, mode: " + KIOSK_MODE);

            if (KIOSK_MODE === "sendspin") {
                initSendspin();
            } else {
                connectWS();
            }

            // Start progress update interval for Sendspin mode
            if (KIOSK_MODE === "sendspin") {
                setInterval(function() {
                    if (sendspinPlayer && sendspinPlayer.trackProgress) {
                        var progress = sendspinPlayer.trackProgress;
                        position = progress.positionMs / 1000;
                        duration = progress.durationMs / 1000;
                        updateUI();
                    }
                }, 500);
            }
        };

        this.handleEvent = function(data) {
            if (data.event === "back") {
                // Prevent back navigation in kiosk mode
                return true;
            }
        };

        // Handle data requests from MSX
        this.handleRequest = function(dataId, data, callback) {
            logger.debug("handleRequest: " + dataId);
            if (dataId === "init") {
                // Return minimal menu structure for kiosk mode
                callback({
                    menu: [{
                        icon: "music-note",
                        label: "Now Playing",
                        data: "request:interaction:kiosk"
                    }]
                });
            } else if (dataId === "kiosk") {
                // Return empty content page
                callback({
                    headline: "Music Assistant Kiosk",
                    items: []
                });
            } else {
                callback(null);
            }
        };
    }

    // Initialize plugin
    TVXPluginTools.onReady(function() {
        TVXInteractionPlugin.setupHandler(new KioskPlugin());
        TVXInteractionPlugin.init();
    });
})();
</script>
</body>
</html>
