<!DOCTYPE html>
<html>
<head>
    <title>MSX Kiosk Player</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fff;
        }

        .sync-indicator {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
            background: rgba(255, 152, 0, 0.9);
            z-index: 1000;
        }
        .sync-indicator.synced { background: rgba(76, 175, 80, 0.9); }
        .sync-indicator.syncing { background: rgba(255, 152, 0, 0.9); animation: pulse 1.5s infinite; }
        .sync-indicator.error { background: rgba(244, 67, 54, 0.9); }
        .sync-indicator.hidden { display: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .kiosk-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            box-sizing: border-box;
        }

        .album-art {
            width: 45vmin;
            height: 45vmin;
            max-width: 400px;
            max-height: 400px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            margin-bottom: 28px;
        }

        .album-art-placeholder {
            width: 45vmin;
            height: 45vmin;
            max-width: 400px;
            max-height: 400px;
            border-radius: 8px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 28px;
            font-size: 80px;
            color: #333;
        }

        .track-title {
            font-size: 1.6rem;
            font-weight: 600;
            text-align: center;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            font-size: 1rem;
            color: rgba(255,255,255,0.6);
            text-align: center;
            margin-top: 8px;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 28px;
            width: min(50vw, 400px);
        }

        .time {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            font-variant-numeric: tabular-nums;
            min-width: 40px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            transition: width 0.3s linear;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 24px;
        }

        .controls.hidden { display: none; }

        .ctrl-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: background 0.15s, color 0.15s;
        }

        .ctrl-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .ctrl-btn.primary {
            width: 64px;
            height: 64px;
            background: #fff;
            color: #000;
            font-size: 32px;
        }

        .ctrl-btn.primary:hover { background: #e0e0e0; }
    </style>
</head>
<body>
<div id="sync-indicator" class="sync-indicator">CONNECTING...</div>

<div class="kiosk-container">
    <img id="album-art" class="album-art" src="" alt="" style="display: none;">
    <div id="album-art-placeholder" class="album-art-placeholder">&#9835;</div>

    <div id="track-title" class="track-title">Waiting for playback...</div>
    <div id="track-artist" class="track-artist"></div>

    <div class="progress-container">
        <span id="time-current" class="time">0:00</span>
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        <span id="time-total" class="time">0:00</span>
    </div>

    <div id="controls" class="controls">
        <button id="btn-prev" class="ctrl-btn" title="Previous">&#9198;</button>
        <button id="btn-play" class="ctrl-btn primary" title="Play/Pause">&#9654;</button>
        <button id="btn-next" class="ctrl-btn" title="Next">&#9197;</button>
    </div>
</div>

<script type="text/javascript">
(function() {
    "use strict";

    // Configuration (injected by server)
    var KIOSK_MODE = "standard";
    var SHOW_CONTROLS = true;
    var SENDSPIN_SERVER = "";
    var BRIDGE_URL = "";

    // State
    var isPlaying = false;
    var position = 0;
    var duration = 0;
    var currentTrack = {};
    var ws = null;
    var wsRetry = 1000;
    var deviceId = "";

    // Sendspin state
    var sendspinPlayer = null;
    var sendspinReady = false;

    // DOM elements
    var syncIndicator = document.getElementById("sync-indicator");
    var albumArt = document.getElementById("album-art");
    var albumArtPlaceholder = document.getElementById("album-art-placeholder");
    var trackTitle = document.getElementById("track-title");
    var trackArtist = document.getElementById("track-artist");
    var timeCurrent = document.getElementById("time-current");
    var timeTotal = document.getElementById("time-total");
    var progressFill = document.getElementById("progress-fill");
    var controls = document.getElementById("controls");
    var btnPlay = document.getElementById("btn-play");
    var btnPrev = document.getElementById("btn-prev");
    var btnNext = document.getElementById("btn-next");

    function generateDeviceId() {
        var chars = "abcdefghijklmnopqrstuvwxyz0123456789";
        var id = "msx_kiosk_";
        for (var i = 0; i < 8; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return id;
    }

    function getUrlParam(name, def) {
        var params = new URLSearchParams(window.location.search);
        return params.get(name) || def;
    }

    function fmtDur(sec) {
        if (!sec || !isFinite(sec) || sec < 0) return "0:00";
        var m = Math.floor(sec / 60);
        var s = Math.floor(sec % 60);
        return m + ":" + (s < 10 ? "0" : "") + s;
    }

    function updateSyncIndicator(status, text) {
        if (!syncIndicator) return;
        syncIndicator.className = "sync-indicator";
        if (status === "synced") {
            syncIndicator.classList.add("synced");
            syncIndicator.textContent = text || "SYNC";
        } else if (status === "syncing") {
            syncIndicator.classList.add("syncing");
            syncIndicator.textContent = text || "SYNCING...";
        } else if (status === "error") {
            syncIndicator.classList.add("error");
            syncIndicator.textContent = text || "ERROR";
        } else if (status === "hidden") {
            syncIndicator.classList.add("hidden");
        } else {
            syncIndicator.textContent = text || "CONNECTING...";
        }
    }

    function updateUI() {
        if (btnPlay) {
            btnPlay.innerHTML = isPlaying ? "&#9208;" : "&#9654;";
            btnPlay.title = isPlaying ? "Pause" : "Play";
        }
        if (timeCurrent) timeCurrent.textContent = fmtDur(position);
        if (timeTotal) timeTotal.textContent = fmtDur(duration);
        if (progressFill && duration > 0) {
            progressFill.style.width = ((position / duration) * 100) + "%";
        }
    }

    function updateTrackInfo(track) {
        currentTrack = track;
        if (trackTitle) trackTitle.textContent = track.title || "No track playing";
        if (trackArtist) trackArtist.textContent = track.artist || "";

        if (albumArt && albumArtPlaceholder) {
            if (track.image) {
                albumArt.src = track.image;
                albumArt.style.display = "";
                albumArtPlaceholder.style.display = "none";
            } else {
                albumArt.style.display = "none";
                albumArtPlaceholder.style.display = "";
            }
        }
        duration = track.duration || 0;
        updateUI();
    }

    // --- Sendspin Mode ---
    function loadSendspinSDK(callback) {
        if (window.__SendspinPlayerClass) {
            callback(window.__SendspinPlayerClass, null);
            return;
        }

        var script = document.createElement("script");
        script.type = "module";
        script.textContent = [
            "import { SendspinPlayer } from 'https://unpkg.com/@music-assistant/sendspin-js@latest/dist/index.js';",
            "window.__SendspinPlayerClass = SendspinPlayer;",
            "window.dispatchEvent(new CustomEvent('sendspin-sdk-loaded'));"
        ].join("\n");

        var loadTimeout = setTimeout(function() {
            callback(null, "SDK load timeout");
        }, 10000);

        window.addEventListener("sendspin-sdk-loaded", function onLoaded() {
            window.removeEventListener("sendspin-sdk-loaded", onLoaded);
            clearTimeout(loadTimeout);
            callback(window.__SendspinPlayerClass || null, window.__SendspinPlayerClass ? null : "SDK not found");
        });

        document.head.appendChild(script);
    }

    function initSendspin() {
        updateSyncIndicator("syncing", "LOADING SDK...");

        loadSendspinSDK(function(PlayerClass, error) {
            if (error || !PlayerClass) {
                console.error("Sendspin SDK load failed:", error);
                updateSyncIndicator("error", "SDK ERROR");
                return;
            }

            console.log("Sendspin SDK loaded, connecting to:", SENDSPIN_SERVER);
            updateSyncIndicator("syncing", "CONNECTING...");

            try {
                sendspinPlayer = new PlayerClass({
                    playerId: deviceId,
                    baseUrl: SENDSPIN_SERVER,
                    clientName: "MSX Kiosk Player",
                    correctionMode: "sync",
                    onStateChange: onSendspinStateChange
                });

                sendspinPlayer.connect()
                    .then(function() {
                        console.log("Sendspin connected");
                        sendspinReady = true;
                        updateSyncIndicator("synced", "SYNC");
                    })
                    .catch(function(err) {
                        console.error("Sendspin connection failed:", err);
                        updateSyncIndicator("error", "CONNECT FAILED");
                    });
            } catch (e) {
                console.error("Sendspin init error:", e);
                updateSyncIndicator("error", "INIT ERROR");
            }
        });
    }

    function onSendspinStateChange(state) {
        isPlaying = sendspinPlayer ? sendspinPlayer.isPlaying : false;

        if (state.serverState && state.serverState.metadata) {
            var meta = state.serverState.metadata;
            updateTrackInfo({
                title: meta.title || "",
                artist: meta.artist || "",
                image: meta.artwork_url || "",
                duration: meta.track_duration ? meta.track_duration / 1000 : 0
            });
        }

        if (sendspinPlayer && sendspinPlayer.trackProgress) {
            var progress = sendspinPlayer.trackProgress;
            position = progress.positionMs / 1000;
            duration = progress.durationMs / 1000;
        }

        if (sendspinPlayer && sendspinPlayer.isClockSynced) {
            updateSyncIndicator("synced", "SYNC");
        } else if (sendspinReady) {
            updateSyncIndicator("syncing", "SYNCING...");
        }

        updateUI();
    }

    // --- Standard Mode (WebSocket) ---
    function connectWS() {
        if (KIOSK_MODE !== "standard") return;

        var wsProto = location.protocol === "https:" ? "wss:" : "ws:";
        var wsHost = BRIDGE_URL ? BRIDGE_URL.replace(/^https?:/, wsProto) : wsProto + "//" + location.host;
        var wsUrl = wsHost + "/ws?device_id=" + encodeURIComponent(deviceId) + "&source=msx_kiosk";

        ws = new WebSocket(wsUrl);
        var thisWs = ws;

        ws.onopen = function() {
            console.log("WebSocket connected");
            wsRetry = 1000;
            updateSyncIndicator("hidden");
        };

        ws.onmessage = function(ev) {
            try {
                handleWSMessage(JSON.parse(ev.data));
            } catch (e) {
                console.warn("WS message error:", e);
            }
        };

        ws.onclose = function(ev) {
            if (ws !== thisWs) return;
            ws = null;
            if (ev.code !== 1000 && ev.code !== 1001) {
                updateSyncIndicator("syncing", "RECONNECTING...");
                setTimeout(connectWS, wsRetry + Math.random() * 1000);
                wsRetry = Math.min(wsRetry * 2, 10000);
            }
        };

        ws.onerror = function() {
            updateSyncIndicator("error", "CONNECTION ERROR");
        };
    }

    function handleWSMessage(msg) {
        switch (msg.type) {
            case "play":
                isPlaying = true;
                updateTrackInfo({
                    title: msg.title || "",
                    artist: msg.artist || "",
                    image: msg.image_url || "",
                    duration: msg.duration || 0
                });
                break;
            case "stop":
                isPlaying = false;
                position = 0;
                updateTrackInfo({ title: "Waiting for playback...", artist: "", image: "", duration: 0 });
                break;
            case "pause":
                isPlaying = false;
                break;
            case "resume":
                isPlaying = true;
                break;
            case "position":
                position = msg.position || 0;
                break;
        }
        updateUI();
    }

    // --- Controls ---
    function togglePlay() {
        if (KIOSK_MODE === "sendspin" && sendspinPlayer && sendspinReady) {
            sendspinPlayer.sendCommand(sendspinPlayer.isPlaying ? "pause" : "play");
        }
    }

    function prevTrack() {
        if (KIOSK_MODE === "sendspin" && sendspinPlayer && sendspinReady) {
            sendspinPlayer.sendCommand("previous");
        }
    }

    function nextTrack() {
        if (KIOSK_MODE === "sendspin" && sendspinPlayer && sendspinReady) {
            sendspinPlayer.sendCommand("next");
        }
    }

    // --- Init ---
    function init() {
        // Parse URL params (fallback to injected values)
        KIOSK_MODE = getUrlParam("mode", KIOSK_MODE) || "standard";
        SHOW_CONTROLS = getUrlParam("controls", String(SHOW_CONTROLS)) === "true";
        SENDSPIN_SERVER = getUrlParam("sendspin_server", SENDSPIN_SERVER) || "";
        BRIDGE_URL = getUrlParam("bridge", BRIDGE_URL) || location.origin;

        deviceId = getUrlParam("device_id", "") || generateDeviceId();

        console.log("Kiosk init: mode=" + KIOSK_MODE + ", controls=" + SHOW_CONTROLS);

        if (controls && !SHOW_CONTROLS) {
            controls.classList.add("hidden");
        }

        if (btnPlay) btnPlay.addEventListener("click", togglePlay);
        if (btnPrev) btnPrev.addEventListener("click", prevTrack);
        if (btnNext) btnNext.addEventListener("click", nextTrack);

        if (KIOSK_MODE === "sendspin") {
            initSendspin();
            setInterval(function() {
                if (sendspinPlayer && sendspinPlayer.trackProgress) {
                    position = sendspinPlayer.trackProgress.positionMs / 1000;
                    duration = sendspinPlayer.trackProgress.durationMs / 1000;
                    updateUI();
                }
            }, 500);
        } else {
            connectWS();
        }
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
