<!DOCTYPE html>
<html>
<head>
    <title>Music Assistant MSX Plugin</title>
    <script src="/msx/tvx-plugin-module.min.js"></script>
</head>
<body>
<script>
(function() {
    var BRIDGE = window.location.protocol + "//" + window.location.host;
    var WS_PROTOCOL = window.location.protocol === "https:" ? "wss:" : "ws:";
    var WS_URL = WS_PROTOCOL + "//" + window.location.host + "/ws";

    function addDeviceParam(url, deviceId) {
        if (!deviceId) return url;
        var sep = url.indexOf("?") >= 0 ? "&" : "?";
        return url + sep + "device_id=" + encodeURIComponent(deviceId);
    }

    function buildMenu(deviceId) {
        return [
            { icon: "search", label: "Search", data: addDeviceParam(BRIDGE + "/msx/search-page.json", deviceId) },
            { icon: "album", label: "Albums", data: addDeviceParam(BRIDGE + "/msx/albums.json", deviceId) },
            { icon: "person", label: "Artists", data: addDeviceParam(BRIDGE + "/msx/artists.json", deviceId) },
            { icon: "queue-music", label: "Playlists", data: addDeviceParam(BRIDGE + "/msx/playlists.json", deviceId) },
            { icon: "audiotrack", label: "Tracks", data: addDeviceParam(BRIDGE + "/msx/tracks.json", deviceId) }
        ];
    }

    function formatDuration(seconds) {
        if (seconds == null || !isFinite(seconds) || seconds < 0) return "";
        var m = Math.floor(seconds / 60);
        var s = Math.floor(seconds % 60);
        return m + ":" + (s < 10 ? "0" : "") + s;
    }

    function connectPushWebSocket(deviceId) {
        if (typeof WebSocket === "undefined") return;
        var url = deviceId ? WS_URL + "?device_id=" + encodeURIComponent(deviceId) : WS_URL;
        var ws = new WebSocket(url);
        ws.onmessage = function(ev) {
            try {
                var msg = JSON.parse(ev.data);
                if (msg.type === "stop" && typeof tvx.InteractionPlugin.executeAction === "function") {
                    var action = msg.showNotification ? "eject" : "player:eject";
                    tvx.InteractionPlugin.executeAction(action);
                } else if (msg.type === "play" && msg.path && typeof tvx.InteractionPlugin.executeAction === "function") {
                    var audioUrl = BRIDGE + msg.path;
                    var playerLabel = msg.title || "Music Assistant";
                    var labelParts = [];
                    if (msg.artist) labelParts.push(msg.artist);
                    var dur = formatDuration(msg.duration);
                    if (dur) labelParts.push(dur);
                    var label = labelParts.join(" · ") || "";
                    var data = { playerLabel: playerLabel };
                    if (label) data.label = label;
                    if (msg.image_url) data.background = msg.image_url;
                    if (msg.duration != null && msg.duration > 0) data.duration = msg.duration;
                    tvx.InteractionPlugin.executeAction("audio:" + audioUrl, data);
                } else if (msg.type === "play_update" && typeof tvx.InteractionPlugin.executeAction === "function") {
                    // Update metadata of the currently playing item without restarting audio.
                    var playerLabelUpdate = msg.title || "Music Assistant";
                    var labelPartsUpdate = [];
                    if (msg.artist) labelPartsUpdate.push(msg.artist);
                    var durUpdate = formatDuration(msg.duration);
                    if (durUpdate) labelPartsUpdate.push(durUpdate);
                    var labelUpdate = labelPartsUpdate.join(" · ") || "";
                    var updateData = { playerLabel: playerLabelUpdate };
                    if (labelUpdate) updateData.label = labelUpdate;
                    if (msg.image_url) updateData.background = msg.image_url;
                    if (msg.duration != null && msg.duration > 0) updateData.duration = msg.duration;
                    tvx.InteractionPlugin.executeAction("player:update", updateData);
                }
            } catch (e) {}
        };
        ws.onclose = function() {
            setTimeout(function() { connectPushWebSocket(deviceId); }, 5000);
        };
    }

    function MAHandler() {}

    MAHandler.prototype.handleRequest = function(dataId, data, callback) {
        if (dataId === "init") {
            var self = this;
            var respond = function(deviceId) {
                callback({
                    name: "Music Assistant",
                    version: "1.0.0",
                    headline: "Music Assistant",
                    menu: buildMenu(deviceId || null)
                });
                connectPushWebSocket(deviceId || null);
            };
            if (typeof tvx.VideoPlugin !== "undefined" && typeof tvx.VideoPlugin.requestDeviceId === "function") {
                tvx.VideoPlugin.requestDeviceId(function(data) {
                    var id = (data && data.deviceId) ? data.deviceId : null;
                    respond(id);
                });
            } else {
                respond(null);
            }
        }
    };

    tvx.PluginTools.onReady(function() {
        tvx.InteractionPlugin.setupHandler(new MAHandler());
        tvx.InteractionPlugin.init();
    });
})();
</script>
</body>
</html>
