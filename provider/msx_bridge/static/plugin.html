<!DOCTYPE html>
<html>
<head>
    <title>Music Assistant MSX Plugin</title>
    <script src="/msx/tvx-plugin-module.min.js"></script>
</head>
<body>
<script>
(function() {
    var BRIDGE = window.location.protocol + "//" + window.location.host;

    function addDeviceParam(url, deviceId) {
        if (!deviceId) return url;
        var sep = url.indexOf("?") >= 0 ? "&" : "?";
        return url + sep + "device_id=" + encodeURIComponent(deviceId);
    }

    function buildMenu(deviceId) {
        return [
            { icon: "search", label: "Search", data: addDeviceParam(BRIDGE + "/msx/search-page.json", deviceId) },
            { icon: "album", label: "Albums", data: addDeviceParam(BRIDGE + "/msx/albums.json", deviceId) },
            { icon: "person", label: "Artists", data: addDeviceParam(BRIDGE + "/msx/artists.json", deviceId) },
            { icon: "queue-music", label: "Playlists", data: addDeviceParam(BRIDGE + "/msx/playlists.json", deviceId) },
            { icon: "audiotrack", label: "Tracks", data: addDeviceParam(BRIDGE + "/msx/tracks.json", deviceId) }
        ];
    }

    function MAHandler() {}

    MAHandler.prototype.handleRequest = function(dataId, data, callback) {
        if (dataId === "init") {
            var self = this;
            var respond = function(deviceId) {
                callback({
                    name: "Music Assistant",
                    version: "1.0.0",
                    headline: "Music Assistant",
                    menu: buildMenu(deviceId || null)
                });
            };
            if (typeof tvx.VideoPlugin !== "undefined" && typeof tvx.VideoPlugin.requestDeviceId === "function") {
                tvx.VideoPlugin.requestDeviceId(function(data) {
                    var id = (data && data.deviceId) ? data.deviceId : null;
                    respond(id);
                });
            } else {
                respond(null);
            }
        }
    };

    tvx.PluginTools.onReady(function() {
        tvx.InteractionPlugin.setupHandler(new MAHandler());
        tvx.InteractionPlugin.init();
    });
})();
</script>
</body>
</html>
