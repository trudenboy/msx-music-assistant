<!DOCTYPE html>
<html>
<head>
    <title>Music Assistant MSX Plugin</title>
    <script src="/msx/tvx-plugin-module.min.js"></script>
</head>
<body>
<script>
(function() {
    var BRIDGE = window.location.protocol + "//" + window.location.host;
    var WS_PROTOCOL = window.location.protocol === "https:" ? "wss:" : "ws:";
    var WS_URL = WS_PROTOCOL + "//" + window.location.host + "/ws";

    function addDeviceParam(url, deviceId) {
        if (!deviceId) return url;
        var sep = url.indexOf("?") >= 0 ? "&" : "?";
        return url + sep + "device_id=" + encodeURIComponent(deviceId);
    }

    function buildSearchRequestAction(deviceId) {
        var searchUrl = BRIDGE + "/msx/search-input.json?q={INPUT}";
        if (deviceId) searchUrl += "&device_id=" + encodeURIComponent(deviceId);
        var inputPluginUrl = BRIDGE + "/msx/input.html";
        if (deviceId) inputPluginUrl += "?device_id=" + encodeURIComponent(deviceId);
        return "request:interaction:" + searchUrl + "|search:3|en|Search Music||||Search..." + "@" + inputPluginUrl;
    }

    function buildMenu(deviceId) {
        return [
            { icon: "history", label: "Recently played", data: addDeviceParam(BRIDGE + "/msx/recently-played.json", deviceId) },
            { icon: "album", label: "Albums", data: addDeviceParam(BRIDGE + "/msx/albums.json", deviceId) },
            { icon: "person", label: "Artists", data: addDeviceParam(BRIDGE + "/msx/artists.json", deviceId) },
            { icon: "queue-music", label: "Playlists", data: addDeviceParam(BRIDGE + "/msx/playlists.json", deviceId) },
            { icon: "audiotrack", label: "Tracks", data: addDeviceParam(BRIDGE + "/msx/tracks.json", deviceId) },
            { icon: "search", label: "Search", data: buildSearchRequestAction(deviceId) }
        ];
    }

    function formatDuration(seconds) {
        if (seconds == null || !isFinite(seconds) || seconds < 0) return "";
        var m = Math.floor(seconds / 60);
        var s = Math.floor(seconds % 60);
        return m + ":" + (s < 10 ? "0" : "") + s;
    }

    function resolveAction(action) {
        if (!action) return null;
        if (action.indexOf("request:interaction:/") === 0) {
            return action.replace("request:interaction:/", "request:interaction:" + BRIDGE + "/");
        }
        if (action.indexOf("/") === 0) {
            return BRIDGE + action;
        }
        return action;
    }

    function connectPushWebSocket(deviceId) {
        if (typeof WebSocket === "undefined") return;
        var url = deviceId ? WS_URL + "?device_id=" + encodeURIComponent(deviceId) : WS_URL;
        var ws = new WebSocket(url);
        ws.onmessage = function(ev) {
            try {
                var msg = JSON.parse(ev.data);
                if (msg.type === "stop" && typeof tvx.InteractionPlugin.executeAction === "function") {
                    var action = msg.showNotification ? "eject" : "[player:eject|player:hide]";
                    tvx.InteractionPlugin.executeAction(action);
                } else if (msg.type === "play" && msg.path && typeof tvx.InteractionPlugin.executeAction === "function") {
                    // Force .mp3 extension for better compatibility with TV players
                    var audioUrl = BRIDGE + msg.path + ".mp3";
                    var playerLabel = msg.title || "Music Assistant";
                    var labelParts = [];
                    if (msg.artist) labelParts.push(msg.artist);
                    var dur = formatDuration(msg.duration);
                    if (dur) labelParts.push(dur);
                    var label = labelParts.join(" · ") || "";
                    var data = { playerLabel: playerLabel };
                    if (label) data.label = label;
                    if (msg.image_url) data.background = msg.image_url;
                    if (msg.duration != null && msg.duration > 0) data.duration = msg.duration;
                    if (msg.next_action) data.nextAction = resolveAction(msg.next_action);
                    if (msg.prev_action) data.prevAction = resolveAction(msg.prev_action);
                    tvx.InteractionPlugin.executeAction("audio:" + audioUrl, data);
                } else if (msg.type === "play_update" && typeof tvx.InteractionPlugin.executeAction === "function") {
                    // Update metadata of the currently playing item without restarting audio.
                    // 'player:set-data' or 'player:update' is not supported on all MSX clients.
                    // For now, we just log it. Real metadata updates happen on track change via 'play' event.
                    /*
                    var playerLabelUpdate = msg.title || "Music Assistant";
                    var labelPartsUpdate = [];
                    if (msg.artist) labelPartsUpdate.push(msg.artist);
                    var durUpdate = formatDuration(msg.duration);
                    if (durUpdate) labelPartsUpdate.push(durUpdate);
                    var labelUpdate = labelPartsUpdate.join(" · ") || "";
                    var updateData = { playerLabel: playerLabelUpdate };
                    if (labelUpdate) updateData.label = labelUpdate;
                    if (msg.image_url) updateData.background = msg.image_url;
                    if (msg.duration != null && msg.duration > 0) updateData.duration = msg.duration;
                    if (msg.next_action) updateData.nextAction = resolveAction(msg.next_action);
                    if (msg.prev_action) updateData.prevAction = resolveAction(msg.prev_action);
                    tvx.InteractionPlugin.executeAction("player:set-data", updateData);
                    */
                    if (typeof console !== "undefined" && console.log) {
                        console.log("MSX play_update received", msg);
                    }
                }
            } catch (e) {
                if (typeof console !== "undefined" && console.warn) {
                    console.warn("MSX push message error", e);
                }
            }
        };
        ws.onclose = function() {
            setTimeout(function() { connectPushWebSocket(deviceId); }, 5000);
        };
    }

    function MAHandler() {}

    MAHandler.prototype.handleRequest = function(dataId, data, callback) {
        if (dataId === "init") {
            var self = this;
            var respond = function(deviceId) {
                callback({
                    name: "Music Assistant",
                    version: "1.0.0",
                    headline: "Music Assistant",
                    menu: buildMenu(deviceId || null)
                });
                connectPushWebSocket(deviceId || null);
            };
            if (typeof tvx.VideoPlugin !== "undefined" && typeof tvx.VideoPlugin.requestDeviceId === "function") {
                tvx.VideoPlugin.requestDeviceId(function(data) {
                    var id = (data && data.deviceId) ? data.deviceId : null;
                    respond(id);
                });
            } else {
                respond(null);
            }
        }
    };

    tvx.PluginTools.onReady(function() {
        tvx.InteractionPlugin.setupHandler(new MAHandler());
        tvx.InteractionPlugin.init();
    });
})();
</script>
</body>
</html>
