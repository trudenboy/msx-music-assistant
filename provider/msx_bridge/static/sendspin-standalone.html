<!DOCTYPE html>
<html>
<head>
    <title>Sendspin Standalone Player</title>
    <meta charset="utf-8">
    <style>
        html, body { margin: 0; padding: 0; background: transparent; }
    </style>
</head>
<body>
<script type="text/javascript">
(function() {
    "use strict";

    var serverUrl = "";
    var playerId = "";
    var bridgeUrl = "";
    var sendspinPlayer = null;
    var SendspinPlayerClass = null;

    // Parse URL parameters (compatible with old browsers)
    function getUrlParam(name) {
        var search = window.location.search.substring(1);
        var params = search.split("&");
        for (var i = 0; i < params.length; i++) {
            var pair = params[i].split("=");
            if (decodeURIComponent(pair[0]) === name) {
                return pair.length > 1 ? decodeURIComponent(pair[1]) : "";
            }
        }
        return "";
    }

    // Generate player ID if not provided
    function generatePlayerId() {
        var chars = "abcdefghijklmnopqrstuvwxyz0123456789";
        var id = "msx_kiosk_";
        for (var i = 0; i < 8; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return id;
    }

    // Check if ES modules are supported
    function supportsESModules() {
        try {
            new Function("import('')");
            return true;
        } catch (e) {
            return false;
        }
    }

    // Notify parent window to fallback to standard mode
    function notifyFallbackToStandard(reason) {
        console.log("Sendspin not available, fallback to standard mode:", reason);
        if (window.parent && window.parent !== window) {
            try {
                window.parent.postMessage({ type: "sendspin-fallback", reason: reason }, "*");
            } catch (e) {}
        }
    }

    // Load Sendspin SDK via ES modules
    function loadSendspinSDKModule(callback) {
        var script = document.createElement("script");
        script.type = "module";
        script.textContent = [
            "import { SendspinPlayer } from 'https://unpkg.com/@music-assistant/sendspin-js@latest/dist/index.js';",
            "window.__SendspinPlayerClass = SendspinPlayer;",
            "window.dispatchEvent(new CustomEvent('sendspin-sdk-loaded'));"
        ].join("\n");

        var loadTimeout = setTimeout(function() {
            callback(null, "SDK load timeout");
        }, 15000);

        window.addEventListener("sendspin-sdk-loaded", function onLoaded() {
            window.removeEventListener("sendspin-sdk-loaded", onLoaded);
            clearTimeout(loadTimeout);
            if (window.__SendspinPlayerClass) {
                callback(window.__SendspinPlayerClass, null);
            } else {
                callback(null, "SDK class not found");
            }
        });

        script.onerror = function() {
            clearTimeout(loadTimeout);
            callback(null, "Failed to load SDK script");
        };

        document.head.appendChild(script);
    }

    // Load bundled Sendspin SDK (for browsers without ES modules)
    function loadSendspinSDKBundled(callback) {
        var script = document.createElement("script");
        script.src = bridgeUrl + "/msx/sendspin-bundle.js";
        
        var loadTimeout = setTimeout(function() {
            callback(null, "Bundled SDK load timeout");
        }, 15000);

        script.onload = function() {
            clearTimeout(loadTimeout);
            if (window.SendspinPlayer) {
                callback(window.SendspinPlayer, null);
            } else {
                callback(null, "Bundled SDK class not found");
            }
        };

        script.onerror = function() {
            clearTimeout(loadTimeout);
            callback(null, "Failed to load bundled SDK");
        };

        document.head.appendChild(script);
    }

    // Load SDK with fallback - try bundled first (more compatible), then ES modules
    function loadSendspinSDK(callback) {
        console.log("Loading Sendspin SDK (bundled first)...");
        loadSendspinSDKBundled(function(PlayerClass, error) {
            if (PlayerClass) {
                console.log("Bundled SDK loaded successfully");
                callback(PlayerClass, null);
            } else {
                console.log("Bundled SDK failed:", error, "- trying ES modules...");
                if (supportsESModules()) {
                    loadSendspinSDKModule(callback);
                } else {
                    callback(null, "SDK not available: " + error);
                }
            }
        });
    }

    // Initialize
    function init() {
        serverUrl = getUrlParam("server");
        playerId = getUrlParam("player_id") || generatePlayerId();
        bridgeUrl = getUrlParam("bridge") || (window.location.protocol + "//" + window.location.host);

        console.log("Sendspin standalone init: server=" + serverUrl + ", player=" + playerId + ", bridge=" + bridgeUrl);

        if (!serverUrl) {
            console.error("No Sendspin server URL provided");
            notifyFallbackToStandard("No server URL");
            return;
        }

        loadSendspinSDK(function(PlayerClass, error) {
            if (error || !PlayerClass) {
                console.error("Sendspin SDK load failed:", error);
                notifyFallbackToStandard(error || "SDK load failed");
                return;
            }

            console.log("Sendspin SDK loaded, creating player...");
            SendspinPlayerClass = PlayerClass;

            try {
                // Get client IP from bridge URL or use playerId
                var clientIp = "";
                try {
                    var bridgeHost = new URL(bridgeUrl).hostname;
                    if (bridgeHost && bridgeHost !== "localhost" && bridgeHost !== "127.0.0.1") {
                        clientIp = bridgeHost;
                    }
                } catch(e) {}
                
                var clientName = "MSX Kiosk";
                if (clientIp) clientName += " (" + clientIp + ")";
                if (playerId) clientName += " [" + playerId + "]";
                
                sendspinPlayer = new PlayerClass({
                    playerId: playerId,
                    baseUrl: serverUrl,
                    clientName: clientName,
                    correctionMode: "sync",
                    onStateChange: function(state) {
                        console.log("Sendspin state change:", state);
                    }
                });

                sendspinPlayer.connect()
                    .then(function() {
                        console.log("Sendspin connected successfully");
                        // Notify parent that sendspin is ready
                        if (window.parent && window.parent !== window) {
                            try {
                                window.parent.postMessage({ type: "sendspin-ready", playerId: playerId }, "*");
                            } catch (e) {}
                        }
                    })
                    .catch(function(err) {
                        console.error("Sendspin connection failed:", err.message);
                        notifyFallbackToStandard("Connection failed: " + err.message);
                    });
            } catch (e) {
                console.error("Sendspin player creation failed:", e.message);
                notifyFallbackToStandard("Player creation failed: " + e.message);
            }
        });
    }

    // Start when DOM ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
