---
name: msx-native-playlist-integration
overview: Перестроить интеграцию MSX Bridge так, чтобы очереди MA лучше соответствовали нативной модели плейлистов MSX и рассмотреть режим без duration как псевдо-радио.
todos: []
isProject: false
---

## Цели

- Перестроить интеграцию так, чтобы воспроизведение альбомов/плейлистов через MSX максимально опиралось на нативные механизмы MSX (`audio:` / `playlist:` / `content:`), а не только на единый flow‑стрим MA.
- Исследовать и, при возможности, реализовать режим «радио», где MSX не знает точную длительность трека (нет `duration`), а очередь полностью управляется MA.

## Краткий анализ ограничений MSX

- `audio:{URL}` и `audio:plugin:{URL}` в [Actions](https://msx.benzac.de/wiki/index.php?title=Actions):
  - запускают **один** аудиопоток; переход на следующий трек нативно не поддерживается.
  - MSX закрывает плеер, когда считает поток завершённым (EOF/обрыв соединения).
- Плейлисты в MSX реализуются через `playlist:{URL}`/`playlist:data` и `content:{URL}`/`content:data`:
  - MSX сам управляет списком элементов и воспроизведением; можно использовать `action:"audio:{URL}"` для каждого элемента.
- Interaction Plugin / Plugin API не содержит действий вроде `player:update`, `player:next` для управления аудиоплеером снаружи; есть только обработка действий ПДУ (`TVXAction.NEXT_TRACK` и т.п.).

## Направление 1: нативный плейлист в MSX поверх MA

- **Идея**: при выборе альбома/плейлиста с MSX строить **контент‑страницу или плейлист MSX**, а не напрямую вызывать `/msx/audio?...` для одного URI.
- **1.1. Формирование контента для MSX**
  - В `[provider/msx_bridge/http_server.py](provider/msx_bridge/http_server.py)` и аналоге в `ma-server`:
    - Для страницы альбома/плейлиста (`/msx/albums/{id}/tracks.json`, `/msx/playlists/{id}/tracks.json`):
      - уже сейчас отдаётся список элементов с `action:"audio:/msx/audio/{player_id}?uri=..."`.
      - Планируемый вариант: добавить *альтернативный* endpoint, который возвращает JSON для `playlist:{URL}` или `playlist:data` (структура как в Content API MSX), чтобы MSX мог запрашивать плейлист целиком.
- **1.2. Переход на `playlist:`/`content:` вместо одиночных `audio:**`
  - В `[static/plugin.html](provider/msx_bridge/static/plugin.html)`:
    - При выборе «Play album/playlist» сгенерировать действие `playlist:{URL}` или `content:{URL}` на MSX, указывая на наш JSON с треками.
    - У каждого элемента плейлиста внутри этого JSON `action` будет `audio:/msx/audio/{player_id}?uri=...` — тем самым **MSX сам будет перебирать элементы**, запуская наш аудио‑endpoint для каждого трека.
- **1.3. Поведение при следующем треке**
  - MSX, управляя плейлистом, будет:
    - по окончании текущего `audio` автоматически запускать следующий `audio:` из того же плейлиста;
    - показывать суммарную длительность/прогресс на своей стороне (по собственным полям `duration`, если они заданы в контенте).
  - MA по‑прежнему будет играть **по одному треку** через `/msx/audio` (flow‑стрим можно отключить для этого режима, вернувшись к одиночным трекам).

## Направление 2: «Радио»-режим без duration

- **2.1. Возможность не передавать duration**
  - В текущем плагине MSX Bridge duration используется только для UI (формат времени и прогресс‑бар).
  - По докам MSX нет требования duration для запуска `audio:` — это чисто дополнительная информация.
  - План:
    - На стороне MA **не указывать `duration` в WS‑сообщениях `play`/`play_update**` (оставить `undefined` или 0) в «радио»‑режиме.
    - В `plugin.html` не передавать `data.duration` в `tvx.InteractionPlugin.executeAction`, если `msg.duration` пустой.
- **2.2. Ожидаемое поведение MSX без duration**
  - Документация не описывает, чтобы MSX закрывал плеер по duration, если duration не задана.
  - Вероятный сценарий:
    - MSX будет считать поток бесконечным до тех пор, пока **сервер не закроет соединение** или пользователь не нажмёт STOP/BACK.
  - Тогда мы получаем «радио»: 
    - MA гоняет единый flow‑стрим (несколько треков подряд);
    - MSX показывает либо без прогресса, либо простой-индикатор, но **не закрывает плеер после первого логического трека**.
- **2.3. Ограничения такого подхода**
  - Пользователь на MSX не будет видеть длительность трека и корректный прогресс.
  - Смена трека в очереди MA будет полностью «прозрачной» для MSX — это именно поведение радио, а не трек‑по‑трек.

## Направление 3: гибридный режим (плейлист + MA очередь)

- **3.1. Использовать MSX‑плейлист как «UI», MA — как источник треков**
  - Для выбора альбома/плейлиста отдавать MSX обычный content/playlist JSON (список треков, названия, обложки, duration).
  - Действия каждого элемента:
    - вместо прямого `audio:{stream_url}`, использовать `audio:/msx/audio/{player_id}?uri={ma_uri}`:
      - MA через `play_media` сам решает, что подать (например, поток с кроссфейдом, эффектами и т.п.);
      - MSX отвечает только за переключение между элементами и отображение.
- **3.2. Поведение по окончании трека**
  - В таком варианте **автопереход к следующему треку целиком реализуется внутри MSX**, а MA отдаёт по одному треку за раз.
  - Это ближе к «традиционному плееру», но жертва — отказ от большого flow‑стрима (и связанных фич) при проигрывании с MSX.

## Шаги для реализации (возможный порядок)

1. **Режим «радио» без duration (минимальное вмешательство)**
  - В бэкенде MSX Bridge (MA и msx-music-assistant):
    - добавить конфиг‑флаг «Radio mode / no duration» для MSX плеера;
    - при включённом флаге **не заполнять `duration**` в `notify_play_started` / `notify_track_updated` и в JSON контента для MSX;
    - убедиться, что HTTP‑стрим в flow‑режиме не обрывается между треками.
  - В `static/plugin.html`:
    - не передавать `data.duration`, если `msg.duration` отсутствует;
  - Протестировать: MSX должен перестать закрывать плеер по окончании первого трека (плеер закрывается только при реальном завершении потока или явном `stop`).
2. **Прототип нативного плейлиста MSX**
  - Создать отдельный endpoint (например, `/msx/album-playlist.json`) в `http_server.py`, который возвращает JSON в формате Content API для выбранного альбома (только MSX‑плейлист, без MA‑очереди).
  - В `plugin.html` добавить кнопку/действие «Play album via MSX playlist», которая вызывает `playlist:{URL}` / `content:{URL}` на этот endpoint.
  - Каждый элемент плейлиста внутри этого JSON использует `action:"audio:/msx/audio/{player_id}?uri=..."` (одиночные треки через MA).
  - Протестировать с MSX, что он сам корректно переходит по плейлисту, а MA правильно обрабатывает одиночные треки.
3. **Выбор режима и доработка UX**
  - В конфиге MSX Bridge (MA и msx-music-assistant) добавить опцию:
    - «Radio mode (flow, no durations)»;
    - «Native MSX playlist (per-track playback)».
  - В `plugin.html` (MSX UI) добавить либо отдельные варианты запуска (Play as Radio / Play as Playlist), либо выбрать дефолтный режим и документировать его поведение.
4. **Документация и обновление PR #3123**
  - В описании PR дополнить раздел «Playback modes»:
    - Radio / flow mode (no durations, MA controls queue);
    - Native MSX playlist mode (MSX controls per-track playback).
  - Чётко описать ограничения каждого режима, чтобы ревьюеры MA понимали компромиссы.

Этот план опирается строго на официальную документацию MSX: `audio:` не поддерживает встроенный «next track», а duration — чисто UI‑атрибут; для настоящих плейлистов предусмотрены `playlist:` и `content:`. Режим «радио» без duration в нашем случае становится единственным способом держать MSX‑плеер открытым поверх долгого flow‑стрима MA, а полноценный трек‑по‑трек контроль предлагается реализовать через нативный плейлист MSX поверх одиночных MA‑стримов.