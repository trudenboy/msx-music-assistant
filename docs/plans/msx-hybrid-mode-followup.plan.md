---
name: msx-hybrid-mode-followup
overview: Пошаговая доработка гибридного режима (MSX плейлист + MA очередь) поверх уже добавленного playback_mode и переключения flow/per-track для /msx/audio.
todos:
  - id: queue-init-hybrid
    content: Спроектировать и описать инициализацию/обновление очереди MA в режиме hybrid_playlist_queue при каждом запросе /msx/audio
    status: pending
  - id: hybrid-error-handling
    content: Продумать обработку ошибок (play_media/get_stream, недоступный трек) и статусы ответов в гибридном режиме
    status: pending
  - id: hybrid-tests-plan
    content: Сформировать конкретный набор unit/ручных тестов для гибридного режима поверх уже существующих тестов msx_bridge
    status: pending
isProject: false
---

## Цели доработки

- Завершить реализацию гибридного режима **hybrid_playlist_queue**, чтобы:
  - MSX управлял списком треков (next/prev, автопереход) через свой плейлист/контент.
  - MA в этом режиме работала строго с **per-track** стримами и согласованной очередью.
- Минимизировать влияние на существующие режимы (`legacy` / будущий `radio`), сохранив back‑compat.

## 1. Поведение очереди MA в гибридном режиме

- **1.1. Инициализация очереди при первом `/msx/audio` в гибриде**
  - В `MSXHTTPServer._handle_msx_audio` для `playback_mode == "hybrid_playlist_queue"`:
    - Перед `play_media` получать/создавать очередь через `mass.player_queues.get(player_id)` / `get_or_create` (по API MA).
    - Если очередь пуста — создать новую с одним элементом по `uri` (аналог произвольного плей/трек).
    - Если очередь не пуста, но `current_item.uri` не совпадает с `uri` запроса —
      - либо перемещать существующий элемент с таким `uri` в текущую позицию;
      - либо (первый этап) очищать очередь и пересоздавать её одним элементом (проще и предсказуемее).
- **1.2. Отказ от flow‑режима подтверждён в очереди**
  - Убедиться, что в гибриде:
    - `queue.flow_mode` не активируется (проверить, как его включает `play_media` в MA).
    - При необходимости, после `play_media` явно выключать `queue.flow_mode` или использовать режим, при котором MA не переключает элементы внутри одного стрима.

## 2. MSX контент для плейлистов/альбомов

- **2.1. Минимальный вариант (без новых эндпоинтов)**
  - Сохранить текущие `tracks.json` (`/msx/albums/{id}/tracks.json`, `/msx/playlists/{id}/tracks.json`):
    - Каждый элемент уже имеет `action: "audio:/msx/audio/{player_id}?uri=..."`.
  - Гибридный режим на первом этапе реализовывать **чисто конфиг‑флагом** на стороне MA:
    - Когда `playback_mode == "hybrid_playlist_queue"`, MSX продолжает вызывать те же `audio:` действия, но сервер уже отдаёт per‑track поток без flow‑стрима.
- **2.2. Подготовка к полноценному MSX‑плейлисту (опционально)**
  - Спроектировать (но не обязательно сразу реализовывать) отдельные эндпоинты
  `/msx/hybrid/album/{id}.json` и `/msx/hybrid/playlist/{id}.json` с форматом `playlist:`/`content:`:
    - структура: заголовок, список треков, действия `audio:/msx/audio/...`.
    - пригодится для будущего расширения UI в `plugin.html` (отдельный режим "Play as Hybrid").

## 3. Согласование состояний MA и MSX

- **3.1. Отношение к next/prev с ПДУ в гибриде**
  - Принять за основу: в режиме `hybrid_playlist_queue` **источником правды по треку является MSX**:
    - next/prev на ПДУ → MSX сам выбирает следующий элемент и вызывает новый `audio:`.
    - MA воспринимает каждый `/msx/audio` как отдельный запрос "сыграть этот трек сейчас".
  - В `MSXHTTPServer._handle_next/_handle_previous` оставить текущее поведение (команды к MA) как второстепенное, с пометкой в доках, что в гибридном режиме ожидаемый путь управления — через MSX.
- **3.2. WebSocket‑уведомления**
  - В гибриде **можно оставить** существующие `notify_play_started`/`notify_track_updated`:
    - они не мешают работе, просто обновляют UI MSX.
  - Убедиться, что логика `poll` в `MSXPlayer` (которая ориентирована на flow‑стрим) не ломает гибрид:
    - при `flow_mode == False` блок обновления метаданных в `poll` фактически не срабатывает (уже так сейчас).

## 4. Обработка ошибок и крайних случаев в гибриде

- **4.1. Ошибки при `play_media`/`get_stream**`
  - В `_handle_msx_audio` для гибрида добавить аккуратный хэндлинг:
    - если `mass.player_queues.play_media` бросает исключение → лог + `5xx` для MSX.
    - если `get_stream` не может создать поток → `5xx` и лог с `player_id` и `uri`.
- **4.2. Несоответствие списков треков**
  - При формировании контента для альбома/плейлиста уже сейчас фильтровать только доступные треки (использовать только те, что возвращаются библиотекой MA).
  - В `/msx/audio` при `get_item_by_uri` == `None` возвращать `404` / `400` с сообщением "Track unavailable" и логировать.

## 5. Тестирование гибридного режима

- **5.1. Unit‑тесты HTTP‑слоя**
  - В `tests/test_http_server.py` дополнить/уточнить:
    - тест, что в гибриде при наличии `duration` выставляется `Content-Length` и `force_flow_mode=False` (уже частично реализовано, можно стабилизировать, не полагаясь на внутреннее свойство `current_media`).
    - тест, что при `playback_mode != "hybrid_playlist_queue"` `force_flow_mode=True` (legacy путь).
    - дополнительные проверки на корректный статус и текст ошибок при:
      - отсутствии `uri`;
      - недоступном треке (`get_item_by_uri` возвращает `None`).
- **5.2. Unit‑тесты очереди/поведения MA**
  - Если появится явное управление очередью (очистка/создание), добавить тесты, которые
  через mock `mass.player_queues` проверяют:
    - вызовы `get`/`get_or_create`;
    - очистку/пересоздание очереди при смене `uri`.
- **5.3. Ручные сценарии**
  - Запуск MA + MSX с `playback_mode="hybrid_playlist_queue"`:
    - воспроизведение альбома/плейлиста → убедиться, что MSX автоматически переходит к следующему треку и не закрывает плеер по окончании первого;
    - ручной next/prev с ПДУ → убедиться, что на каждом шаге `/msx/audio` вызывается с нужным `uri` и MA играет правильный трек;
    - проверка, что при смене режима обратно на `legacy` поведение flow‑стрима остаётся прежним.

## 6. Документация и миграция

- **6.1. Описание режимов**
  - В `README.md` / документации провайдера описать:
    - `legacy` — текущий режим (flow‑стрим для `/msx/audio`).
    - `hybrid_playlist_queue` — MSX‑плейлист + per‑track стримы MA, как его включить и ограничения.
- **6.2. Путь миграции**
  - Рекомендовать на первом этапе включать гибридный режим только на тестовых инстансах:
    - чтобы отловить возможные расхождения в UX между MA UI и MSX.

